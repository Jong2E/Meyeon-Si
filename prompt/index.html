<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <title>커리큘럼 장바구니</title>
  <style>
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; display: flex; flex-direction: column; margin: 0; height: 100vh; background-color: #f4f7f6; }
    .header { padding: 15px 20px; background-color: #ffffff; border-bottom: 1px solid #ddd; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    .header h1 { margin: 0; font-size: 24px; color: #333; }
    .controls { display: flex; align-items: center; gap: 15px; }
    .controls input { padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
    .controls button { padding: 8px 15px; background-color: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }
    .controls button:hover { background-color: #218838; }
    .container { display: flex; flex: 1; padding: 20px; box-sizing: border-box; overflow: hidden; }
    .panel { display: flex; flex-direction: column; width: 50%; padding: 20px; box-sizing: border-box; background-color: #fff; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    .panel:first-child { margin-right: 10px; }
    .panel:last-child { margin-left: 10px; }
    h2 { text-align: center; color: #333; border-bottom: 2px solid #eee; padding-bottom: 10px; margin-top: 0; }
    ul { list-style-type: none; padding: 0; margin: 0; overflow-y: auto; flex-grow: 1; }
    li { padding: 12px 15px; margin-bottom: 8px; background-color: #fafafa; border-radius: 4px; cursor: grab; transition: background-color 0.3s, box-shadow 0.3s; display: flex; justify-content: space-between; align-items: center; border-left: 4px solid #007bff; }
    li:hover { background-color: #f1f1f1; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    li.dragging { opacity: 0.5; background: #e0e0e0; }
    .item-title { font-weight: 600; }
    .item-details { font-size: 0.9em; color: #555; margin-top: 4px; }
    .accordion-title { cursor: pointer; padding: 12px; background-color: #f0f0f0; margin-top: 5px; border-radius: 4px; font-weight: bold; user-select: none; }
    .accordion-content { padding-left: 15px; display: none; }
    #total-time { text-align: right; margin-top: 20px; font-size: 1.3em; font-weight: bold; color: #dc3545; }
    #admin-link-container { position: fixed; bottom: 10px; right: 15px; font-size: 14px; z-index: 999; }
    #admin-link-container a { color: #888; text-decoration: none; cursor: pointer; }
    #admin-link-container a:hover { text-decoration: underline; }
  </style>
</head>
<body>

<div class="header">
  <h1>커리큘럼 구성</h1>
  <div class="controls">
    <input type="text" id="company-name" placeholder="고객사명">
    <input type="text" id="manager-name" placeholder="담당자명">
    <button onclick="completeSelection()">완성하기</button>
  </div>
</div>

<div class="container">
  <div class="panel">
    <h2>전체 커리큘럼</h2>
    <div id="curriculum-list-container" style="overflow-y: auto;"></div>
  </div>

  <div class="panel">
    <h2>선택된 커리큘럼</h2>
    <ul id="cart-list"></ul>
    <div id="total-time">총 소요 시간: 0시간 0분</div>
  </div>
</div>

<div id="admin-link-container">
  <a onclick="goToAdmin()">관리자</a>
</div>

<script>
  let allCurriculums = [];
  const curriculumListContainer = document.getElementById('curriculum-list-container');
  const cartList = document.getElementById('cart-list');
  const totalTimeEl = document.getElementById('total-time');

  // 데이터 로드
  document.addEventListener('DOMContentLoaded', () => {
    google.script.run.withSuccessHandler(data => {
      allCurriculums = data;
      renderCurriculumList();
    }).getCurriculumData();
  });

  function renderCurriculumList() {
    const availableCurriculums = allCurriculums.filter(item => 
        !Array.from(cartList.children).some(li => li.dataset.id == item.id)
    );

    const grouped = availableCurriculums.reduce((acc, item) => {
      acc[item.cat1] = acc[item.cat1] || {};
      acc[item.cat1][item.cat2] = acc[item.cat1][item.cat2] || [];
      acc[item.cat1][item.cat2].push(item);
      return acc;
    }, {});

    curriculumListContainer.innerHTML = '';
    for (const cat1 in grouped) {
      const cat1Div = document.createElement('div');
      const cat1Title = createAccordionTitle(cat1);
      cat1Div.appendChild(cat1Title);

      const cat1Content = document.createElement('div');
      cat1Content.className = 'accordion-content';

      for (const cat2 in grouped[cat1]) {
        const cat2Div = document.createElement('div');
        const cat2Title = createAccordionTitle(cat2, true);
        cat2Div.appendChild(cat2Title);

        const cat2Content = document.createElement('ul');
        cat2Content.className = 'accordion-content';
        cat2Content.style.display = 'block';

        grouped[cat1][cat2].forEach(item => {
          const li = createCurriculumItem(item);
          li.onclick = () => addToCart(item);
          cat2Content.appendChild(li);
        });

        cat2Div.appendChild(cat2Content);
        cat1Content.appendChild(cat2Div);
      }
      cat1Div.appendChild(cat1Content);
      curriculumListContainer.appendChild(cat1Div);
    }
  }
  
  function createAccordionTitle(title, isSub = false) {
      const titleEl = document.createElement('div');
      titleEl.className = 'accordion-title';
      titleEl.textContent = title;
      if(isSub) titleEl.style.backgroundColor = '#f8f8f8';
      titleEl.onclick = (e) => {
          e.stopPropagation();
          const content = e.target.nextElementSibling;
          content.style.display = content.style.display === 'block' ? 'none' : 'block';
      };
      return titleEl;
  }

  function createCurriculumItem(item) {
    const li = document.createElement('li');
    li.dataset.id = item.id;
    li.innerHTML = `
      <div>
        <div class="item-title">${item.title}</div>
        <div class="item-details">${item.details || ''} | ${item.time}분 | ${item.tool || ''}</div>
      </div>
      <span>+</span>
    `;
    return li;
  }

  function addToCart(item) {
    const li = createCartItem(item);
    cartList.appendChild(li);
    updateTotalTime();
    renderCurriculumList();
  }

  function createCartItem(item) {
    const li = document.createElement('li');
    li.dataset.id = item.id;
    li.draggable = true;
    li.innerHTML = `
      <div>
        <div class="item-title">${item.title}</div>
        <div class="item-details">${item.cat1} > ${item.cat2}</div>
      </div>
      <button style="background:none; border:none; cursor:pointer; font-size:18px;" onclick="removeFromCart(this)">×</button>
    `;
    addDragDropHandlers(li);
    return li;
  }

  function removeFromCart(button) {
    button.parentElement.remove();
    updateTotalTime();
    renderCurriculumList();
  }

  function updateTotalTime() {
    let totalMinutes = 0;
    Array.from(cartList.children).forEach(li => {
      const item = allCurriculums.find(c => c.id == li.dataset.id);
      if (item) totalMinutes += Number(item.time);
    });
    const hours = Math.floor(totalMinutes / 60);
    const minutes = totalMinutes % 60;
    totalTimeEl.textContent = `총 소요 시간: ${hours}시간 ${minutes}분`;
  }

  // 드래그 앤 드롭
  let draggedItem = null;
  function addDragDropHandlers(item) {
    item.addEventListener('dragstart', () => {
      draggedItem = item;
      setTimeout(() => item.classList.add('dragging'), 0);
    });
    item.addEventListener('dragend', () => {
      setTimeout(() => {
          draggedItem.classList.remove('dragging');
          draggedItem = null;
      }, 0);
    });
    item.addEventListener('dragover', e => {
      e.preventDefault();
      const afterElement = getDragAfterElement(cartList, e.clientY);
      if (afterElement == null) {
        cartList.appendChild(draggedItem);
      } else {
        cartList.insertBefore(draggedItem, afterElement);
      }
    });
  }

  function getDragAfterElement(container, y) {
    const draggableElements = [...container.querySelectorAll('li:not(.dragging)')];
    return draggableElements.reduce((closest, child) => {
      const box = child.getBoundingClientRect();
      const offset = y - box.top - box.height / 2;
      if (offset < 0 && offset > closest.offset) {
        return { offset: offset, element: child };
      } else {
        return closest;
      }
    }, { offset: Number.NEGATIVE_INFINITY }).element;
  }

  // 완성하기
  function completeSelection() {
    const company = document.getElementById('company-name').value;
    const manager = document.getElementById('manager-name').value;
    if (!company || !manager) {
      alert('고객사명과 담당자명을 모두 입력해주세요.');
      return;
    }

    const cartItems = Array.from(cartList.children).map(li => {
        return allCurriculums.find(c => c.id == li.dataset.id);
    });

    const totalMinutes = cartItems.reduce((sum, item) => sum + Number(item.time), 0);
    const hours = Math.floor(totalMinutes / 60);
    const minutes = totalMinutes % 60;

    const data = {
      company: company,
      manager: manager,
      totalTime: `${hours}시간 ${minutes}분`,
      curriculumList: cartItems
    };

    document.body.style.cursor = 'wait';
    google.script.run.withSuccessHandler(response => {
      document.body.style.cursor = 'default';
      if (response.success) {
        alert(`'${response.sheetName}' 시트가 생성되었습니다.`);
        cartList.innerHTML = '';
        updateTotalTime();
        renderCurriculumList();
      } else {
        alert('오류가 발생했습니다: ' + response.message);
      }
    }).saveCustomerRequest(data);
  }

  // 관리자 페이지로 이동
  function goToAdmin() {
    const password = prompt("관리자 비밀번호를 입력하세요:");
    if (password === null) { // 사용자가 '취소'를 눌렀을 경우
      return;
    }
    
    google.script.run.withSuccessHandler(isCorrect => {
      if (isCorrect) {
        // 현재 URL을 기반으로 관리자 페이지 URL을 만들어 이동
        const currentUrl = window.location.href;
        const baseUrl = currentUrl.split('?')[0];
        window.open(baseUrl + '?page=admin', '_self');
      } else {
        alert('비밀번호가 틀렸습니다.');
      }
    }).checkPassword(password);
  }

</script>
</body>
</html>